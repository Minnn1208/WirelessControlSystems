C51 COMPILER V9.00   IIC                                                                   03/05/2024 15:12:11 PAGE 1   


C51 COMPILER V9.00, COMPILATION OF MODULE IIC
OBJECT MODULE PLACED IN .\Objects\iic.obj
COMPILER INVOKED BY: E:\Keil4\C51\BIN\C51.EXE App\iic\iic.c BROWSE INCDIR(.\App\24c02;.\App\iic;.\App\serial_debug;.\Pub
                    -lic) DEBUG OBJECTEXTEND PRINT(.\Listings\iic.lst) OBJECT(.\Objects\iic.obj)

line level    source

   1          #include "iic.h"
   2          
   3          
   4          /*******************************************************************************
   5          * 函 数 名       : iic_start
   6          * 函数功能               : 产生IIC起始信号
   7          * 输    入       : 无
   8          * 输    出       : 无
   9          *******************************************************************************/
  10          void iic_start(void)
  11          {
  12   1              IIC_SDA=1;//如果把该条语句放在SCL后面，第二次读写会出现问题
  13   1              delay_10us(1);
  14   1              IIC_SCL=1;
  15   1              delay_10us(1);
  16   1              IIC_SDA=0;      //当SCL为高电平时，SDA由高变为低
  17   1              delay_10us(1);
  18   1              IIC_SCL=0;//钳住I2C总线，准备发送或接收数据
  19   1              delay_10us(1);
  20   1              
  21   1      }
  22          
  23          /*******************************************************************************
  24          * 函 数 名         : iic_stop
  25          * 函数功能                 : 产生IIC停止信号   
  26          * 输    入         : 无
  27          * 输    出         : 无
  28          *******************************************************************************/
  29          void iic_stop(void)
  30          {       
  31   1              IIC_SDA=0;//如果把该条语句放在SCL后面，第二次读写会出现问题
  32   1              delay_10us(1);
  33   1              IIC_SCL=1;
  34   1              delay_10us(1);
  35   1              IIC_SDA=1;      //当SCL为高电平时，SDA由低变为高
  36   1              delay_10us(1);                  
  37   1      }
  38          
  39          /*******************************************************************************
  40          * 函 数 名         : iic_ack
  41          * 函数功能                 : 产生ACK应答  
  42          * 输    入         : 无
  43          * 输    出         : 无
  44          *******************************************************************************/
  45          void iic_ack(void)
  46          {
  47   1              IIC_SCL=0;
  48   1              IIC_SDA=0;      //SDA为低电平
  49   1              delay_10us(1);
  50   1              IIC_SCL=1;
  51   1              delay_10us(1);
  52   1              IIC_SCL=0;
  53   1      }
  54          
C51 COMPILER V9.00   IIC                                                                   03/05/2024 15:12:11 PAGE 2   

  55          /*******************************************************************************
  56          * 函 数 名         : iic_nack
  57          * 函数功能                 : 产生NACK非应答  
  58          * 输    入         : 无
  59          * 输    出         : 无
  60          *******************************************************************************/
  61          void iic_nack(void)
  62          {
  63   1              IIC_SCL=0;
  64   1              IIC_SDA=1;      //SDA为高电平
  65   1              delay_10us(1);
  66   1              IIC_SCL=1;
  67   1              delay_10us(1);
  68   1              IIC_SCL=0;      
  69   1      }
  70          
  71          /*******************************************************************************
  72          * 函 数 名         : iic_wait_ack
  73          * 函数功能                 : 等待应答信号到来   
  74          * 输    入         : 无
  75          * 输    出         : 1，接收应答失败
  76                                           0，接收应答成功
  77          *******************************************************************************/
  78          u8 iic_wait_ack(void)
  79          {
  80   1              u8 time_temp=0;
  81   1              
  82   1              IIC_SCL=1;
  83   1              delay_10us(1);
  84   1              while(IIC_SDA)  //等待SDA为低电平
  85   1              {
  86   2                      time_temp++;
  87   2                      if(time_temp>100)//超时则强制结束IIC通信
  88   2                      {       
  89   3                              iic_stop();
  90   3                              return 1;       
  91   3                      }                       
  92   2              }
  93   1              IIC_SCL=0;
  94   1              return 0;       
  95   1      }
  96          
  97          /*******************************************************************************
  98          * 函 数 名         : iic_write_byte
  99          * 函数功能                 : IIC发送一个字节 
 100          * 输    入         : dat：发送一个字节
 101          * 输    出         : 无
 102          *******************************************************************************/
 103          void iic_write_byte(u8 dat)
 104          {                        
 105   1          u8 i=0; 
 106   1                          
 107   1          IIC_SCL=0;
 108   1          for(i=0;i<8;i++)    //循环8次将一个字节传出，先传高再传低位
 109   1          {              
 110   2              if((dat&0x80)>0) 
 111   2                              IIC_SDA=1;
 112   2                      else
 113   2                              IIC_SDA=0;
 114   2              dat<<=1;          
 115   2                      delay_10us(1);  
 116   2                      IIC_SCL=1;
C51 COMPILER V9.00   IIC                                                                   03/05/2024 15:12:11 PAGE 3   

 117   2                      delay_10us(1); 
 118   2                      IIC_SCL=0;      
 119   2                      delay_10us(1);
 120   2          }    
 121   1      }
 122          
 123          /*******************************************************************************
 124          * 函 数 名         : iic_read_byte
 125          * 函数功能                 : IIC读一个字节 
 126          * 输    入         : ack=1时，发送ACK，ack=0，发送nACK 
 127          * 输    出         : 应答或非应答
 128          *******************************************************************************/
 129          u8 iic_read_byte(u8 ack)
 130          {
 131   1              u8 i=0,receive=0;
 132   1              
 133   1          for(i=0;i<8;i++ )   //循环8次将一个字节读出，先读高再传低位
 134   1              {
 135   2              IIC_SCL=0; 
 136   2              delay_10us(1);
 137   2                      IIC_SCL=1;
 138   2              receive<<=1;
 139   2              if(IIC_SDA)receive++;   
 140   2                      delay_10us(1); 
 141   2          }                                    
 142   1          if (!ack)
 143   1              iic_nack();
 144   1          else
 145   1              iic_ack();  
 146   1                        
 147   1          return receive;
 148   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    270    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----       6
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
